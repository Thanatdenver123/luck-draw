<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• - HRD By P'TUM</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; text-align: center; padding: 20px; }
        h1 { color: #333; margin-bottom: 10px; }
        
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; max-width: 1200px; margin: 0 auto; }
        
        .wheel-section { flex: 2; min-width: 320px; display: flex; flex-direction: column; align-items: center; }
        .wheel-container { position: relative; margin: 20px 0; }
        canvas { border-radius: 50%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .pointer { 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; z-index: 10;
            border-left: 25px solid transparent; border-right: 25px solid transparent; border-top: 50px solid #ff3b3b; 
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3));
        }
        #spinBtn {
            padding: 15px 50px; font-size: 28px; font-weight: bold; background: linear-gradient(135deg, #ff4757, #ff6b81);
            color: white; border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); transition: 0.3s;
        }
        #spinBtn:hover { transform: scale(1.05); }
        #spinBtn:disabled { background: #ccc; cursor: not-allowed; }

        .control-section { flex: 1; min-width: 300px; text-align: left; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 15px; border: 1px solid #eee; padding: 15px; border-radius: 10px; background: #fafafa; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        button.add-btn { width: 100%; padding: 12px; background: #2ed573; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .winner-list { margin-top: 15px; max-height: 350px; overflow-y: auto; }
        .winner-item { display: flex; justify-content: space-between; align-items: center; background: #f1f2f6; padding: 10px; margin-bottom: 8px; border-radius: 8px; }
        .winner-thumb { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; margin-right: 10px; }

        /* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ Modal ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°‡πÜ --- */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        .modal-content { background-color: white; margin: 2% auto; padding: 20px; border-radius: 25px; width: 90%; max-width: 600px; text-align: center; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á/‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
        .winner-image-container { width: 100%; max-height: 450px; overflow: hidden; border-radius: 15px; margin-bottom: 20px; background: #eee; }
        .winner-image-large { width: 100%; height: 100%; object-fit: contain; /* ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö */ display: block; }
        
        .modal h2 { font-size: 36px; color: #ff4757; margin: 10px 0; }
        .modal-btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn-confirm { background: #2ed573; color: white; padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .btn-cancel { background: #747d8c; color: white; padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>

    <h1>üé° ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏¥‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• Lucky Draw HRD BY P'TUM</h1>

    <div class="container">
        <div class="wheel-section">
            <div class="wheel-container">
                <div class="pointer"></div>
                <canvas id="wheelCanvas" width="500" height="500"></canvas>
            </div>
            <button id="spinBtn" onclick="spinWheel()">‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏•‡∏¢! (SPIN)</button>
        </div>

        <div class="control-section">
            <h3>üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</h3>
            <div class="input-group">
                <input type="text" id="newName" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠..." onkeypress="handleEnter(event)">
                <input type="file" id="newImage" accept="image/*">
                <button onclick="addCandidate()" class="add-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <h4>‡πÉ‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠: <span id="candidateCount">0</span></h4>
                <button onclick="resetAll()" style="color:red; border:none; background:none; cursor:pointer;">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div id="winnerListContainer" class="winner-list"></div>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <p style="font-size: 20px;">üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• üéâ</p>
            <div class="winner-image-container">
                <img id="winnerImagePopup" class="winner-image-large" src="" alt="Winner">
            </div>
            <h2 id="winnerNameDisplay">...</h2>
            <div class="modal-btn-group">
                <button onclick="confirmWin()" class="btn-confirm">‚úÖ ‡∏ï‡∏Å‡∏•‡∏á</button>
                <button onclick="closeModal()" class="btn-cancel">‚ùå ‡πÇ‡∏°‡∏Ü‡∏∞</button>
            </div>
        </div>
    </div>

    <script>
        let candidates = JSON.parse(localStorage.getItem('candidates_v2')) || [];
        let winners = JSON.parse(localStorage.getItem('winners_v2')) || [];
        let tempWinner = null;

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; // ‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 70% (0.7) ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå jpeg ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        async function addCandidate() {
            const nameInput = document.getElementById('newName');
            const fileInput = document.getElementById('newImage');
            const name = nameInput.value.trim();
            const file = fileInput.files[0];

            if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");

            let imgData = null;
            if (file) {
                imgData = await compressImage(file);
            }

            candidates.push({ id: Date.now(), text: name, img: imgData });
            nameInput.value = '';
            fileInput.value = '';
            saveData();
        }

        function saveData() {
            try {
                localStorage.setItem('candidates_v2', JSON.stringify(candidates));
                localStorage.setItem('winners_v2', JSON.stringify(winners));
            } catch (e) {
                alert("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏ï‡πá‡∏°! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏á");
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('candidateCount').innerText = candidates.length;
            const container = document.getElementById('winnerListContainer');
            container.innerHTML = winners.map(w => `
                <div class="winner-item">
                    <div style="display:flex; align-items:center;">
                        <img src="${w.img || ''}" class="winner-thumb" style="${w.img ? '' : 'display:none'}">
                        <strong>${w.text}</strong>
                    </div>
                    <button onclick="restoreCandidate(${w.id})" class="restore-btn">‚Ü© ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤</button>
                </div>
            `).join('');
            drawWheel();
        }

        function restoreCandidate(id) {
            const idx = winners.findIndex(w => w.id === id);
            if (idx > -1) {
                candidates.push(winners[idx]);
                winners.splice(idx, 1);
                saveData();
            }
        }

        function resetAll() { if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { candidates=[]; winners=[]; saveData(); } }
        function handleEnter(e) { if(e.key === 'Enter') addCandidate(); }

        // --- ‡∏ß‡∏á‡∏•‡πâ‡∏≠ (Canvas) ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#1A535C', '#FF9F1C', '#C44D58', '#2A9D8F'];
        let startAngle = 0;
        let isSpinning = false;

        function drawWheel() {
            if (candidates.length === 0) { ctx.clearRect(0,0,500,500); return; }
            let arc = (2 * Math.PI) / candidates.length;
            ctx.clearRect(0,0,500,500);
            for(let i = 0; i < candidates.length; i++) {
                let angle = startAngle + i * arc;
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath(); ctx.moveTo(250, 250); ctx.arc(250, 250, 230, angle, angle + arc); ctx.fill();
                ctx.save(); ctx.fillStyle = "white"; ctx.translate(250 + Math.cos(angle + arc/2)*160, 250 + Math.sin(angle + arc/2)*160);
                ctx.rotate(angle + arc/2 + Math.PI/2); ctx.font = 'bold 20px Sarabun';
                let txt = candidates[i].text; ctx.fillText(txt.substring(0,10), -ctx.measureText(txt.substring(0,10)).width/2, 0);
                ctx.restore();
            }
        }

        function spinWheel() {
            if (isSpinning || candidates.length === 0) return;
            isSpinning = true;
            let duration = Math.random() * 3000 + 4000;
            let velocity = Math.random() * 30 + 20;
            let startTime = null;

            function animate(now) {
                if (!startTime) startTime = now;
                let elapsed = now - startTime;
                if (elapsed < duration) {
                    let progress = elapsed / duration;
                    let easeOut = 1 - Math.pow(1 - progress, 3);
                    startAngle += (velocity * (1 - easeOut)) * Math.PI / 180;
                    drawWheel();
                    requestAnimationFrame(animate);
                } else {
                    isSpinning = false;
                    const arc = (2 * Math.PI) / candidates.length;
                    const degrees = (startAngle * 180 / Math.PI) + 90;
                    const index = Math.floor((360 - (degrees % 360)) / (arc * 180 / Math.PI)) % candidates.length;
                    tempWinner = candidates[index];
                    showModal(tempWinner);
                }
            }
            requestAnimationFrame(animate);
        }

        function showModal(w) {
            const img = document.getElementById('winnerImagePopup');
            img.src = w.img || '';
            img.parentElement.style.display = w.img ? 'block' : 'none';
            document.getElementById('winnerNameDisplay').innerText = w.text;
            document.getElementById('resultModal').style.display = 'block';
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        function closeModal() { document.getElementById('resultModal').style.display = 'none'; }
        function confirmWin() {
            const idx = candidates.findIndex(c => c.id === tempWinner.id);
            winners.unshift(candidates[idx]);
            candidates.splice(idx, 1);
            saveData();
            closeModal();
        }

        updateUI();
    </script>
</body>
</html>

